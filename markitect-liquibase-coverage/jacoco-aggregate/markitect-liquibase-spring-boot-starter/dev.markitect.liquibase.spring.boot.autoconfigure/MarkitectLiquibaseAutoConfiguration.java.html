<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>MarkitectLiquibaseAutoConfiguration.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">markitect-liquibase-coverage</a> &gt; <a href="../index.html" class="el_bundle">markitect-liquibase-spring-boot-starter</a> &gt; <a href="index.source.html" class="el_package">dev.markitect.liquibase.spring.boot.autoconfigure</a> &gt; <span class="el_source">MarkitectLiquibaseAutoConfiguration.java</span></div><h1>MarkitectLiquibaseAutoConfiguration.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2023-2024 Markitect
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package dev.markitect.liquibase.spring.boot.autoconfigure;

import static com.google.common.base.Preconditions.checkNotNull;
import static com.google.common.base.Verify.verifyNotNull;
import static java.util.function.Predicate.not;

import com.google.common.annotations.VisibleForTesting;
import dev.markitect.liquibase.spring.MarkitectSpringLiquibase;
import dev.markitect.liquibase.spring.SpringLiquibaseBeanPostProcessor;
import dev.markitect.liquibase.spring.boot.autoconfigure.MarkitectLiquibaseAutoConfiguration.LiquibaseAutoConfigurationRuntimeHints;
import dev.markitect.liquibase.spring.boot.autoconfigure.MarkitectLiquibaseAutoConfiguration.LiquibaseDataSourceCondition;
import java.lang.reflect.InvocationTargetException;
import java.util.Optional;
import javax.sql.DataSource;
import liquibase.Liquibase;
import liquibase.UpdateSummaryEnum;
import liquibase.UpdateSummaryOutputEnum;
import liquibase.change.DatabaseChange;
import liquibase.integration.spring.Customizer;
import liquibase.integration.spring.SpringLiquibase;
import liquibase.ui.UIServiceEnum;
import org.jspecify.annotations.Nullable;
import org.springframework.aot.hint.RuntimeHints;
import org.springframework.aot.hint.RuntimeHintsRegistrar;
import org.springframework.beans.factory.ObjectProvider;
import org.springframework.boot.autoconfigure.AutoConfiguration;
import org.springframework.boot.autoconfigure.condition.AnyNestedCondition;
import org.springframework.boot.autoconfigure.condition.ConditionalOnBean;
import org.springframework.boot.autoconfigure.condition.ConditionalOnClass;
import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
import org.springframework.boot.autoconfigure.jdbc.JdbcConnectionDetails;
import org.springframework.boot.autoconfigure.liquibase.LiquibaseAutoConfiguration;
import org.springframework.boot.autoconfigure.liquibase.LiquibaseConnectionDetails;
import org.springframework.boot.autoconfigure.liquibase.LiquibaseDataSource;
import org.springframework.boot.autoconfigure.liquibase.LiquibaseProperties;
import org.springframework.boot.autoconfigure.orm.jpa.HibernateJpaAutoConfiguration;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.boot.jdbc.DataSourceBuilder;
import org.springframework.boot.sql.init.dependency.DatabaseInitializationDependencyConfigurer;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Conditional;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Import;
import org.springframework.context.annotation.ImportRuntimeHints;
import org.springframework.core.env.Environment;
import org.springframework.jdbc.core.ConnectionCallback;
import org.springframework.jdbc.datasource.SimpleDriverDataSource;
import org.springframework.util.Assert;
import org.springframework.util.CollectionUtils;
import org.springframework.util.StringUtils;

@AutoConfiguration(
    before = LiquibaseAutoConfiguration.class,
    after = {DataSourceAutoConfiguration.class, HibernateJpaAutoConfiguration.class})
@ConditionalOnClass({SpringLiquibase.class, DatabaseChange.class})
@ConditionalOnProperty(prefix = &quot;spring.liquibase&quot;, name = &quot;enabled&quot;, matchIfMissing = true)
@Conditional(LiquibaseDataSourceCondition.class)
@Import(DatabaseInitializationDependencyConfigurer.class)
@ImportRuntimeHints(LiquibaseAutoConfigurationRuntimeHints.class)
public class MarkitectLiquibaseAutoConfiguration {
  @Bean
  public static SpringLiquibaseBeanPostProcessor springLiquibaseBeanPostProcessor(
      Environment environment) {
<span class="fc" id="L82">    return new SpringLiquibaseBeanPostProcessor(environment);</span>
  }

  private MarkitectLiquibaseAutoConfiguration() {}

  @Configuration(proxyBeanMethods = false)
  @ConditionalOnClass(ConnectionCallback.class)
  @ConditionalOnMissingBean(SpringLiquibase.class)
  @EnableConfigurationProperties({LiquibaseProperties.class, MarkitectLiquibaseProperties.class})
<span class="fc" id="L91">  public static class MarkitectLiquibaseConfiguration {</span>
    @Bean
    @ConditionalOnMissingBean(LiquibaseConnectionDetails.class)
    PropertiesLiquibaseConnectionDetails liquibaseConnectionDetails(
        LiquibaseProperties properties) {
<span class="fc" id="L96">      return new PropertiesLiquibaseConnectionDetails(properties);</span>
    }

    @Bean
    SpringLiquibase liquibase(
        ObjectProvider&lt;DataSource&gt; dataSource,
        @LiquibaseDataSource ObjectProvider&lt;DataSource&gt; liquibaseDataSource,
        LiquibaseProperties properties,
        ObjectProvider&lt;SpringLiquibaseCustomizer&gt; customizers,
        LiquibaseConnectionDetails connectionDetails,
        MarkitectLiquibaseProperties markitectProperties) {
<span class="fc" id="L107">      return toSpringLiquibase(</span>
<span class="fc" id="L108">          dataSource.getIfUnique(),</span>
<span class="fc" id="L109">          liquibaseDataSource.getIfAvailable(),</span>
          properties,
          customizers,
          connectionDetails,
          markitectProperties);
    }

    private static SpringLiquibase toSpringLiquibase(
        @Nullable DataSource dataSource,
        @Nullable DataSource liquibaseDataSource,
        LiquibaseProperties properties,
        ObjectProvider&lt;SpringLiquibaseCustomizer&gt; customizers,
        LiquibaseConnectionDetails connectionDetails,
        MarkitectLiquibaseProperties markitectProperties) {
<span class="fc" id="L123">      var migrationDataSource =</span>
<span class="fc" id="L124">          toMigrationDataSource(liquibaseDataSource, dataSource, connectionDetails);</span>
<span class="fc" id="L125">      var liquibase = new MarkitectSpringLiquibase();</span>
<span class="fc" id="L126">      liquibase.setDropFirst(properties.isDropFirst());</span>
<span class="fc" id="L127">      liquibase.setClearCheckSums(properties.isClearChecksums());</span>
<span class="fc" id="L128">      liquibase.setShouldRun(properties.isEnabled());</span>
<span class="fc" id="L129">      liquibase.setDataSource(migrationDataSource);</span>
<span class="fc" id="L130">      liquibase.setChangeLog(properties.getChangeLog());</span>
      try {
<span class="fc" id="L132">        Optional.ofNullable(properties.getContexts())</span>
<span class="fc" id="L133">            .filter(not(CollectionUtils::isEmpty))</span>
<span class="fc" id="L134">            .map(StringUtils::collectionToCommaDelimitedString)</span>
<span class="fc" id="L135">            .ifPresent(liquibase::setContexts);</span>
<span class="nc" id="L136">      } catch (NoSuchMethodError e) {</span>
        // Spring Boot 3.3 and earlier
        try {
<span class="nc" id="L139">          liquibase.setContexts(</span>
<span class="nc" id="L140">              (String) LiquibaseProperties.class.getMethod(&quot;getContexts&quot;).invoke(properties));</span>
<span class="nc" id="L141">        } catch (NoSuchMethodException</span>
            | IllegalAccessException
            | InvocationTargetException
            | RuntimeException unused) {
          // Unsupported Spring Boot version
<span class="nc" id="L146">          throw e;</span>
<span class="nc" id="L147">        }</span>
<span class="fc" id="L148">      }</span>
      try {
<span class="fc" id="L150">        Optional.ofNullable(properties.getLabelFilter())</span>
<span class="fc" id="L151">            .filter(not(CollectionUtils::isEmpty))</span>
<span class="fc" id="L152">            .map(StringUtils::collectionToCommaDelimitedString)</span>
<span class="fc" id="L153">            .ifPresent(liquibase::setLabelFilter);</span>
<span class="nc" id="L154">      } catch (NoSuchMethodError e) {</span>
        // Spring Boot 3.3 and earlier
        try {
<span class="nc" id="L157">          liquibase.setLabelFilter(</span>
<span class="nc" id="L158">              (String) LiquibaseProperties.class.getMethod(&quot;getLabelFilter&quot;).invoke(properties));</span>
<span class="nc" id="L159">        } catch (NoSuchMethodException</span>
            | IllegalAccessException
            | InvocationTargetException
            | RuntimeException unused) {
          // Unsupported Spring Boot version
<span class="nc" id="L164">          throw e;</span>
<span class="nc" id="L165">        }</span>
<span class="fc" id="L166">      }</span>
<span class="fc" id="L167">      liquibase.setTag(properties.getTag());</span>
<span class="fc" id="L168">      liquibase.setDefaultSchema(properties.getDefaultSchema());</span>
<span class="fc" id="L169">      liquibase.setLiquibaseTablespace(properties.getLiquibaseTablespace());</span>
<span class="fc" id="L170">      liquibase.setLiquibaseSchema(properties.getLiquibaseSchema());</span>
<span class="fc" id="L171">      liquibase.setDatabaseChangeLogTable(properties.getDatabaseChangeLogTable());</span>
<span class="fc" id="L172">      liquibase.setDatabaseChangeLogLockTable(properties.getDatabaseChangeLogLockTable());</span>
<span class="fc" id="L173">      liquibase.setTestRollbackOnUpdate(properties.isTestRollbackOnUpdate());</span>
<span class="fc" id="L174">      liquibase.setChangeLogParameters(properties.getParameters());</span>
<span class="fc" id="L175">      liquibase.setRollbackFile(properties.getRollbackFile());</span>
<span class="fc" id="L176">      Optional.ofNullable(properties.getShowSummary())</span>
<span class="fc" id="L177">          .map(Enum::name)</span>
<span class="fc" id="L178">          .map(UpdateSummaryEnum::valueOf)</span>
<span class="fc" id="L179">          .ifPresent(liquibase::setShowSummary);</span>
<span class="fc" id="L180">      Optional.ofNullable(properties.getShowSummaryOutput())</span>
<span class="fc" id="L181">          .map(Enum::name)</span>
<span class="fc" id="L182">          .map(UpdateSummaryOutputEnum::valueOf)</span>
<span class="fc" id="L183">          .ifPresent(liquibase::setShowSummaryOutput);</span>
      try {
<span class="fc" id="L185">        Optional.ofNullable(properties.getUiService())</span>
<span class="fc" id="L186">            .map(Enum::name)</span>
<span class="fc" id="L187">            .map(UIServiceEnum::valueOf)</span>
<span class="fc" id="L188">            .ifPresent(liquibase::setUiService);</span>
<span class="nc" id="L189">      } catch (NoSuchMethodError ignore) {</span>
        // Not supported on Spring Boot 3.2
<span class="fc" id="L191">      }</span>
<span class="pc" id="L192">      customizers.orderedStream().forEach(customizer -&gt; customizer.customize(liquibase));</span>
<span class="fc" id="L193">      liquibase.setOutputDefaultCatalog(markitectProperties.isOutputDefaultCatalog());</span>
<span class="fc" id="L194">      liquibase.setOutputDefaultSchema(markitectProperties.isOutputDefaultSchema());</span>
<span class="fc" id="L195">      return liquibase;</span>
    }

    private static DataSource toMigrationDataSource(
        @Nullable DataSource liquibaseDataSource,
        @Nullable DataSource dataSource,
        LiquibaseConnectionDetails connectionDetails) {
<span class="fc bfc" id="L202" title="All 2 branches covered.">      if (liquibaseDataSource != null) {</span>
<span class="fc" id="L203">        return liquibaseDataSource;</span>
      }
<span class="fc" id="L205">      String url = connectionDetails.getJdbcUrl();</span>
<span class="fc bfc" id="L206" title="All 2 branches covered.">      if (url != null) {</span>
<span class="fc" id="L207">        var builder = DataSourceBuilder.create();</span>
<span class="fc" id="L208">        builder.type(SimpleDriverDataSource.class);</span>
<span class="fc" id="L209">        builder.url(url);</span>
<span class="fc" id="L210">        applyCommonBuilderProperties(connectionDetails, builder);</span>
<span class="fc" id="L211">        return builder.build();</span>
      }
<span class="fc bfc" id="L213" title="All 2 branches covered.">      Assert.state(dataSource != null, &quot;Liquibase migration DataSource missing&quot;);</span>
<span class="fc bfc" id="L214" title="All 2 branches covered.">      if (connectionDetails.getUsername() != null) {</span>
<span class="fc" id="L215">        var builder = DataSourceBuilder.derivedFrom(dataSource);</span>
<span class="fc" id="L216">        builder.type(SimpleDriverDataSource.class);</span>
<span class="fc" id="L217">        applyCommonBuilderProperties(connectionDetails, builder);</span>
<span class="fc" id="L218">        return builder.build();</span>
      }
<span class="fc" id="L220">      return verifyNotNull(dataSource);</span>
    }

    private static void applyCommonBuilderProperties(
        LiquibaseConnectionDetails connectionDetails, DataSourceBuilder&lt;?&gt; builder) {
<span class="fc" id="L225">      builder.username(connectionDetails.getUsername());</span>
<span class="fc" id="L226">      builder.password(connectionDetails.getPassword());</span>
<span class="fc" id="L227">      Optional.ofNullable(connectionDetails.getDriverClassName())</span>
<span class="fc" id="L228">          .filter(StringUtils::hasText)</span>
<span class="fc" id="L229">          .ifPresent(builder::driverClassName);</span>
<span class="fc" id="L230">    }</span>
  }

  @ConditionalOnClass(Customizer.class)
  @SuppressWarnings(&quot;unused&quot;)
<span class="fc" id="L235">  static class CustomizerConfiguration {</span>
    @Bean
    @ConditionalOnBean(Customizer.class)
    SpringLiquibaseCustomizer springLiquibaseCustomizer(Customizer&lt;Liquibase&gt; customizer) {
<span class="nc" id="L239">      return liquibase -&gt; liquibase.setCustomizer(customizer);</span>
    }
  }

  static final class LiquibaseDataSourceCondition extends AnyNestedCondition {
    LiquibaseDataSourceCondition() {
<span class="fc" id="L245">      super(ConfigurationPhase.REGISTER_BEAN);</span>
<span class="fc" id="L246">    }</span>

    @ConditionalOnBean(DataSource.class)
    @SuppressWarnings(&quot;unused&quot;)
    interface DataSourceBeanCondition {}

    @ConditionalOnBean(JdbcConnectionDetails.class)
    @SuppressWarnings(&quot;unused&quot;)
    private static final class JdbcConnectionDetailsCondition {}

    @ConditionalOnProperty(prefix = &quot;spring.liquibase&quot;, name = &quot;url&quot;)
    @SuppressWarnings(&quot;unused&quot;)
    interface LiquibaseUrlCondition {}
  }

<span class="fc" id="L261">  static class LiquibaseAutoConfigurationRuntimeHints implements RuntimeHintsRegistrar {</span>
    @Override
    public void registerHints(RuntimeHints hints, @Nullable ClassLoader classLoader) {
<span class="fc" id="L264">      hints.resources().registerPattern(&quot;db/changelog/*&quot;);</span>
<span class="fc" id="L265">    }</span>
  }

  static final class PropertiesLiquibaseConnectionDetails implements LiquibaseConnectionDetails {
    private final LiquibaseProperties properties;

<span class="fc" id="L271">    PropertiesLiquibaseConnectionDetails(LiquibaseProperties properties) {</span>
<span class="fc" id="L272">      checkNotNull(properties, &quot;Properties must not be null&quot;);</span>
<span class="fc" id="L273">      this.properties = properties;</span>
<span class="fc" id="L274">    }</span>

    @Override
    public @Nullable String getUsername() {
<span class="fc" id="L278">      return properties.getUser();</span>
    }

    @Override
    public @Nullable String getPassword() {
<span class="fc" id="L283">      return properties.getPassword();</span>
    }

    @Override
    public @Nullable String getJdbcUrl() {
<span class="fc" id="L288">      return properties.getUrl();</span>
    }

    @Override
    public @Nullable String getDriverClassName() {
<span class="fc" id="L293">      return Optional.ofNullable(properties.getDriverClassName())</span>
<span class="fc" id="L294">          .orElseGet(LiquibaseConnectionDetails.super::getDriverClassName);</span>
    }
  }

  @FunctionalInterface
  @VisibleForTesting
  interface SpringLiquibaseCustomizer {
    void customize(SpringLiquibase liquibase);
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>