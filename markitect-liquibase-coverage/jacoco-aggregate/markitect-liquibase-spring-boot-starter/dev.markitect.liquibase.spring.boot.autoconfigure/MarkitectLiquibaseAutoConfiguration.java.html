<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>MarkitectLiquibaseAutoConfiguration.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">markitect-liquibase-coverage</a> &gt; <a href="../index.html" class="el_bundle">markitect-liquibase-spring-boot-starter</a> &gt; <a href="index.source.html" class="el_package">dev.markitect.liquibase.spring.boot.autoconfigure</a> &gt; <span class="el_source">MarkitectLiquibaseAutoConfiguration.java</span></div><h1>MarkitectLiquibaseAutoConfiguration.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2023 Markitect
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package dev.markitect.liquibase.spring.boot.autoconfigure;

import dev.markitect.liquibase.spring.MarkitectSpringLiquibase;
import dev.markitect.liquibase.spring.SpringLiquibaseBeanPostProcessor;
import dev.markitect.liquibase.spring.boot.autoconfigure.MarkitectLiquibaseAutoConfiguration.LiquibaseDataSourceCondition;
import java.util.Optional;
import javax.sql.DataSource;
import liquibase.change.DatabaseChange;
import liquibase.integration.spring.SpringLiquibase;
import org.springframework.beans.factory.ObjectProvider;
import org.springframework.boot.autoconfigure.AutoConfiguration;
import org.springframework.boot.autoconfigure.condition.AnyNestedCondition;
import org.springframework.boot.autoconfigure.condition.ConditionalOnBean;
import org.springframework.boot.autoconfigure.condition.ConditionalOnClass;
import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
import org.springframework.boot.autoconfigure.liquibase.LiquibaseAutoConfiguration;
import org.springframework.boot.autoconfigure.liquibase.LiquibaseDataSource;
import org.springframework.boot.autoconfigure.liquibase.LiquibaseProperties;
import org.springframework.boot.autoconfigure.orm.jpa.HibernateJpaAutoConfiguration;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.boot.jdbc.DataSourceBuilder;
import org.springframework.boot.sql.init.dependency.DatabaseInitializationDependencyConfigurer;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Conditional;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Import;
import org.springframework.core.env.Environment;
import org.springframework.jdbc.core.ConnectionCallback;
import org.springframework.jdbc.datasource.SimpleDriverDataSource;
import org.springframework.lang.Nullable;
import org.springframework.util.Assert;
import org.springframework.util.StringUtils;

@AutoConfiguration(
    before = LiquibaseAutoConfiguration.class,
    after = {DataSourceAutoConfiguration.class, HibernateJpaAutoConfiguration.class})
@ConditionalOnClass({SpringLiquibase.class, DatabaseChange.class})
@ConditionalOnProperty(prefix = &quot;spring.liquibase&quot;, name = &quot;enabled&quot;, matchIfMissing = true)
@Conditional(LiquibaseDataSourceCondition.class)
@Import(DatabaseInitializationDependencyConfigurer.class)
<span class="fc" id="L59">public class MarkitectLiquibaseAutoConfiguration {</span>
  @Bean
  public SpringLiquibaseBeanPostProcessor springLiquibaseBeanPostProcessor(
      Environment environment) {
<span class="fc" id="L63">    return new SpringLiquibaseBeanPostProcessor(environment);</span>
  }

  @Configuration(proxyBeanMethods = false)
  @ConditionalOnClass(ConnectionCallback.class)
  @ConditionalOnMissingBean(SpringLiquibase.class)
  @EnableConfigurationProperties({LiquibaseProperties.class, MarkitectLiquibaseProperties.class})
  public static class MarkitectLiquibaseConfiguration {
    private final LiquibaseProperties properties;
    private final MarkitectLiquibaseProperties markitectProperties;

    MarkitectLiquibaseConfiguration(
<span class="fc" id="L75">        LiquibaseProperties properties, MarkitectLiquibaseProperties markitectProperties) {</span>
<span class="fc" id="L76">      Assert.notNull(properties, &quot;Properties must not be null&quot;);</span>
<span class="fc" id="L77">      Assert.notNull(markitectProperties, &quot;MarkitectProperties must not be null&quot;);</span>
<span class="fc" id="L78">      this.properties = properties;</span>
<span class="fc" id="L79">      this.markitectProperties = markitectProperties;</span>
<span class="fc" id="L80">    }</span>

    @Bean
    SpringLiquibase liquibase(
        @SuppressWarnings(&quot;SpringJavaInjectionPointsAutowiringInspection&quot;) @LiquibaseDataSource
            ObjectProvider&lt;DataSource&gt; liquibaseDataSource,
        ObjectProvider&lt;DataSource&gt; dataSource) {
<span class="fc" id="L87">      return toSpringLiquibase(liquibaseDataSource.getIfAvailable(), dataSource.getIfUnique());</span>
    }

    private SpringLiquibase toSpringLiquibase(
        @Nullable DataSource liquibaseDataSource, @Nullable DataSource dataSource) {
<span class="fc" id="L92">      var migrationDataSource = toMigrationDataSource(liquibaseDataSource, dataSource);</span>
<span class="fc" id="L93">      var liquibase = new MarkitectSpringLiquibase();</span>
<span class="fc" id="L94">      liquibase.setDropFirst(properties.isDropFirst());</span>
<span class="fc" id="L95">      liquibase.setClearCheckSums(properties.isClearChecksums());</span>
<span class="fc" id="L96">      liquibase.setShouldRun(properties.isEnabled());</span>
<span class="fc" id="L97">      liquibase.setDataSource(migrationDataSource);</span>
<span class="fc" id="L98">      liquibase.setChangeLog(properties.getChangeLog());</span>
<span class="fc" id="L99">      liquibase.setContexts(properties.getContexts());</span>
<span class="fc" id="L100">      liquibase.setLabelFilter(properties.getLabels());</span>
<span class="fc" id="L101">      liquibase.setTag(properties.getTag());</span>
<span class="fc" id="L102">      liquibase.setDefaultSchema(properties.getDefaultSchema());</span>
<span class="fc" id="L103">      liquibase.setLiquibaseTablespace(properties.getLiquibaseTablespace());</span>
<span class="fc" id="L104">      liquibase.setLiquibaseSchema(properties.getLiquibaseSchema());</span>
<span class="fc" id="L105">      liquibase.setDatabaseChangeLogTable(properties.getDatabaseChangeLogTable());</span>
<span class="fc" id="L106">      liquibase.setDatabaseChangeLogLockTable(properties.getDatabaseChangeLogLockTable());</span>
<span class="fc" id="L107">      liquibase.setTestRollbackOnUpdate(properties.isTestRollbackOnUpdate());</span>
<span class="fc" id="L108">      liquibase.setChangeLogParameters(properties.getParameters());</span>
<span class="fc" id="L109">      liquibase.setRollbackFile(properties.getRollbackFile());</span>
<span class="fc bfc" id="L110" title="All 4 branches covered.">      liquibase.setCloseDataSourceOnceMigrated(</span>
          migrationDataSource != liquibaseDataSource &amp;&amp; migrationDataSource != dataSource);
<span class="fc" id="L112">      liquibase.setOutputDefaultCatalog(markitectProperties.isOutputDefaultCatalog());</span>
<span class="fc" id="L113">      liquibase.setOutputDefaultSchema(markitectProperties.isOutputDefaultSchema());</span>
<span class="fc" id="L114">      return liquibase;</span>
    }

    private DataSource toMigrationDataSource(
        @Nullable DataSource liquibaseDataSource, @Nullable DataSource dataSource) {
<span class="fc bfc" id="L119" title="All 2 branches covered.">      if (liquibaseDataSource != null) {</span>
<span class="fc" id="L120">        return liquibaseDataSource;</span>
      }
<span class="fc" id="L122">      String url = properties.getUrl();</span>
<span class="fc bfc" id="L123" title="All 2 branches covered.">      if (url != null) {</span>
<span class="fc" id="L124">        var builder = DataSourceBuilder.create();</span>
<span class="fc" id="L125">        builder.type(SimpleDriverDataSource.class);</span>
<span class="fc" id="L126">        builder.url(url);</span>
<span class="fc" id="L127">        applyCommonBuilderProperties(builder);</span>
<span class="fc" id="L128">        return builder.build();</span>
      }
<span class="fc bfc" id="L130" title="All 2 branches covered.">      Assert.state(dataSource != null, &quot;Liquibase migration DataSource missing&quot;);</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">      if (properties.getUser() != null) {</span>
<span class="fc" id="L132">        var builder = DataSourceBuilder.derivedFrom(dataSource);</span>
<span class="fc" id="L133">        builder.type(SimpleDriverDataSource.class);</span>
<span class="fc" id="L134">        applyCommonBuilderProperties(builder);</span>
<span class="fc" id="L135">        return builder.build();</span>
      }
<span class="fc" id="L137">      return dataSource;</span>
    }

    private void applyCommonBuilderProperties(DataSourceBuilder&lt;?&gt; builder) {
<span class="fc" id="L141">      Optional.ofNullable(properties.getDriverClassName())</span>
<span class="fc" id="L142">          .filter(StringUtils::hasText)</span>
<span class="fc" id="L143">          .ifPresent(builder::driverClassName);</span>
<span class="fc" id="L144">      builder.username(properties.getUser());</span>
<span class="fc" id="L145">      builder.password(properties.getPassword());</span>
<span class="fc" id="L146">    }</span>
  }

  static final class LiquibaseDataSourceCondition extends AnyNestedCondition {
    LiquibaseDataSourceCondition() {
<span class="fc" id="L151">      super(ConfigurationPhase.REGISTER_BEAN);</span>
<span class="fc" id="L152">    }</span>

    @ConditionalOnBean(DataSource.class)
    @SuppressWarnings(&quot;unused&quot;)
    interface DataSourceBeanCondition {}

    @ConditionalOnProperty(prefix = &quot;spring.liquibase&quot;, name = &quot;url&quot;)
    @SuppressWarnings(&quot;unused&quot;)
    interface LiquibaseUrlCondition {}
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>