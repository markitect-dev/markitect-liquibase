<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>MarkitectLiquibaseAutoConfiguration.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">markitect-liquibase-coverage</a> &gt; <a href="../index.html" class="el_bundle">markitect-liquibase-spring-boot-starter</a> &gt; <a href="index.source.html" class="el_package">dev.markitect.liquibase.spring.boot.autoconfigure</a> &gt; <span class="el_source">MarkitectLiquibaseAutoConfiguration.java</span></div><h1>MarkitectLiquibaseAutoConfiguration.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2023 Markitect
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package dev.markitect.liquibase.spring.boot.autoconfigure;

import static dev.markitect.liquibase.base.Preconditions.checkNotNull;
import static dev.markitect.liquibase.base.Verify.verifyNotNull;

import dev.markitect.liquibase.spring.MarkitectSpringLiquibase;
import dev.markitect.liquibase.spring.SpringLiquibaseBeanPostProcessor;
import dev.markitect.liquibase.spring.boot.autoconfigure.MarkitectLiquibaseAutoConfiguration.LiquibaseAutoConfigurationRuntimeHints;
import dev.markitect.liquibase.spring.boot.autoconfigure.MarkitectLiquibaseAutoConfiguration.LiquibaseDataSourceCondition;
import java.util.Optional;
import javax.sql.DataSource;
import liquibase.change.DatabaseChange;
import liquibase.integration.spring.SpringLiquibase;
import org.checkerframework.checker.nullness.qual.Nullable;
import org.springframework.aot.hint.RuntimeHints;
import org.springframework.aot.hint.RuntimeHintsRegistrar;
import org.springframework.beans.factory.ObjectProvider;
import org.springframework.boot.autoconfigure.AutoConfiguration;
import org.springframework.boot.autoconfigure.condition.AnyNestedCondition;
import org.springframework.boot.autoconfigure.condition.ConditionalOnBean;
import org.springframework.boot.autoconfigure.condition.ConditionalOnClass;
import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
import org.springframework.boot.autoconfigure.jdbc.JdbcConnectionDetails;
import org.springframework.boot.autoconfigure.liquibase.LiquibaseAutoConfiguration;
import org.springframework.boot.autoconfigure.liquibase.LiquibaseConnectionDetails;
import org.springframework.boot.autoconfigure.liquibase.LiquibaseDataSource;
import org.springframework.boot.autoconfigure.liquibase.LiquibaseProperties;
import org.springframework.boot.autoconfigure.orm.jpa.HibernateJpaAutoConfiguration;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.boot.jdbc.DataSourceBuilder;
import org.springframework.boot.sql.init.dependency.DatabaseInitializationDependencyConfigurer;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Conditional;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Import;
import org.springframework.context.annotation.ImportRuntimeHints;
import org.springframework.core.env.Environment;
import org.springframework.jdbc.core.ConnectionCallback;
import org.springframework.jdbc.datasource.SimpleDriverDataSource;
import org.springframework.util.Assert;
import org.springframework.util.StringUtils;

@AutoConfiguration(
    before = LiquibaseAutoConfiguration.class,
    after = {DataSourceAutoConfiguration.class, HibernateJpaAutoConfiguration.class})
@ConditionalOnClass({SpringLiquibase.class, DatabaseChange.class})
@ConditionalOnProperty(prefix = &quot;spring.liquibase&quot;, name = &quot;enabled&quot;, matchIfMissing = true)
@Conditional(LiquibaseDataSourceCondition.class)
@Import(DatabaseInitializationDependencyConfigurer.class)
@ImportRuntimeHints(LiquibaseAutoConfigurationRuntimeHints.class)
<span class="fc" id="L69">public class MarkitectLiquibaseAutoConfiguration {</span>
  @Bean
  public SpringLiquibaseBeanPostProcessor springLiquibaseBeanPostProcessor(
      Environment environment) {
<span class="fc" id="L73">    return new SpringLiquibaseBeanPostProcessor(environment);</span>
  }

  @Configuration(proxyBeanMethods = false)
  @ConditionalOnClass(ConnectionCallback.class)
  @ConditionalOnMissingBean(SpringLiquibase.class)
  @EnableConfigurationProperties({LiquibaseProperties.class, MarkitectLiquibaseProperties.class})
<span class="fc" id="L80">  public static class MarkitectLiquibaseConfiguration {</span>
    @Bean
    @ConditionalOnMissingBean(LiquibaseConnectionDetails.class)
    PropertiesLiquibaseConnectionDetails liquibaseConnectionDetails(
        LiquibaseProperties properties) {
<span class="fc" id="L85">      return new PropertiesLiquibaseConnectionDetails(properties);</span>
    }

    @Bean
    SpringLiquibase liquibase(
        ObjectProvider&lt;DataSource&gt; dataSource,
        @LiquibaseDataSource @SuppressWarnings(&quot;SpringJavaInjectionPointsAutowiringInspection&quot;)
            ObjectProvider&lt;DataSource&gt; liquibaseDataSource,
        LiquibaseProperties properties,
        LiquibaseConnectionDetails connectionDetails,
        MarkitectLiquibaseProperties markitectProperties) {
<span class="fc" id="L96">      return toSpringLiquibase(</span>
<span class="fc" id="L97">          dataSource.getIfUnique(),</span>
<span class="fc" id="L98">          liquibaseDataSource.getIfAvailable(),</span>
          properties,
          connectionDetails,
          markitectProperties);
    }

    private static SpringLiquibase toSpringLiquibase(
        @Nullable DataSource dataSource,
        @Nullable DataSource liquibaseDataSource,
        LiquibaseProperties properties,
        LiquibaseConnectionDetails connectionDetails,
        MarkitectLiquibaseProperties markitectProperties) {
<span class="fc" id="L110">      var migrationDataSource =</span>
<span class="fc" id="L111">          toMigrationDataSource(liquibaseDataSource, dataSource, connectionDetails);</span>
<span class="fc" id="L112">      var liquibase = new MarkitectSpringLiquibase();</span>
<span class="fc" id="L113">      liquibase.setDropFirst(properties.isDropFirst());</span>
<span class="fc" id="L114">      liquibase.setClearCheckSums(properties.isClearChecksums());</span>
<span class="fc" id="L115">      liquibase.setShouldRun(properties.isEnabled());</span>
<span class="fc" id="L116">      liquibase.setDataSource(migrationDataSource);</span>
<span class="fc" id="L117">      liquibase.setChangeLog(properties.getChangeLog());</span>
<span class="fc" id="L118">      liquibase.setContexts(properties.getContexts());</span>
<span class="fc" id="L119">      liquibase.setLabelFilter(properties.getLabelFilter());</span>
<span class="fc" id="L120">      liquibase.setTag(properties.getTag());</span>
<span class="fc" id="L121">      liquibase.setDefaultSchema(properties.getDefaultSchema());</span>
<span class="fc" id="L122">      liquibase.setLiquibaseTablespace(properties.getLiquibaseTablespace());</span>
<span class="fc" id="L123">      liquibase.setLiquibaseSchema(properties.getLiquibaseSchema());</span>
<span class="fc" id="L124">      liquibase.setDatabaseChangeLogTable(properties.getDatabaseChangeLogTable());</span>
<span class="fc" id="L125">      liquibase.setDatabaseChangeLogLockTable(properties.getDatabaseChangeLogLockTable());</span>
<span class="fc" id="L126">      liquibase.setTestRollbackOnUpdate(properties.isTestRollbackOnUpdate());</span>
<span class="fc" id="L127">      liquibase.setChangeLogParameters(properties.getParameters());</span>
<span class="fc" id="L128">      liquibase.setRollbackFile(properties.getRollbackFile());</span>
<span class="fc" id="L129">      liquibase.setOutputDefaultCatalog(markitectProperties.isOutputDefaultCatalog());</span>
<span class="fc" id="L130">      liquibase.setOutputDefaultSchema(markitectProperties.isOutputDefaultSchema());</span>
<span class="fc" id="L131">      return liquibase;</span>
    }

    private static DataSource toMigrationDataSource(
        @Nullable DataSource liquibaseDataSource,
        @Nullable DataSource dataSource,
        LiquibaseConnectionDetails connectionDetails) {
<span class="fc bfc" id="L138" title="All 2 branches covered.">      if (liquibaseDataSource != null) {</span>
<span class="fc" id="L139">        return liquibaseDataSource;</span>
      }
<span class="fc" id="L141">      @Nullable String url = connectionDetails.getJdbcUrl();</span>
<span class="fc bfc" id="L142" title="All 2 branches covered.">      if (url != null) {</span>
<span class="fc" id="L143">        var builder = DataSourceBuilder.create();</span>
<span class="fc" id="L144">        builder.type(SimpleDriverDataSource.class);</span>
<span class="fc" id="L145">        builder.url(url);</span>
<span class="fc" id="L146">        applyCommonBuilderProperties(connectionDetails, builder);</span>
<span class="fc" id="L147">        return builder.build();</span>
      }
<span class="fc bfc" id="L149" title="All 2 branches covered.">      Assert.state(dataSource != null, &quot;Liquibase migration DataSource missing&quot;);</span>
<span class="fc bfc" id="L150" title="All 2 branches covered.">      if (connectionDetails.getUsername() != null) {</span>
<span class="fc" id="L151">        var builder = DataSourceBuilder.derivedFrom(dataSource);</span>
<span class="fc" id="L152">        builder.type(SimpleDriverDataSource.class);</span>
<span class="fc" id="L153">        applyCommonBuilderProperties(connectionDetails, builder);</span>
<span class="fc" id="L154">        return builder.build();</span>
      }
<span class="fc" id="L156">      return verifyNotNull(dataSource);</span>
    }

    private static void applyCommonBuilderProperties(
        LiquibaseConnectionDetails connectionDetails, DataSourceBuilder&lt;?&gt; builder) {
<span class="fc" id="L161">      builder.username(connectionDetails.getUsername());</span>
<span class="fc" id="L162">      builder.password(connectionDetails.getPassword());</span>
<span class="fc" id="L163">      Optional.ofNullable(connectionDetails.getDriverClassName())</span>
<span class="fc" id="L164">          .filter(StringUtils::hasText)</span>
<span class="fc" id="L165">          .ifPresent(builder::driverClassName);</span>
<span class="fc" id="L166">    }</span>
  }

  static final class LiquibaseDataSourceCondition extends AnyNestedCondition {
    LiquibaseDataSourceCondition() {
<span class="fc" id="L171">      super(ConfigurationPhase.REGISTER_BEAN);</span>
<span class="fc" id="L172">    }</span>

    @ConditionalOnBean(DataSource.class)
    @SuppressWarnings(&quot;unused&quot;)
    interface DataSourceBeanCondition {}

    @ConditionalOnBean(JdbcConnectionDetails.class)
    @SuppressWarnings(&quot;unused&quot;)
    private static final class JdbcConnectionDetailsCondition {}

    @ConditionalOnProperty(prefix = &quot;spring.liquibase&quot;, name = &quot;url&quot;)
    @SuppressWarnings(&quot;unused&quot;)
    interface LiquibaseUrlCondition {}
  }

<span class="fc" id="L187">  static class LiquibaseAutoConfigurationRuntimeHints implements RuntimeHintsRegistrar {</span>
    @Override
    public void registerHints(RuntimeHints hints, @Nullable ClassLoader classLoader) {
<span class="fc" id="L190">      hints.resources().registerPattern(&quot;db/changelog/*&quot;);</span>
<span class="fc" id="L191">    }</span>
  }

  static final class PropertiesLiquibaseConnectionDetails implements LiquibaseConnectionDetails {
    private final LiquibaseProperties properties;

<span class="fc" id="L197">    PropertiesLiquibaseConnectionDetails(LiquibaseProperties properties) {</span>
<span class="fc" id="L198">      checkNotNull(properties, &quot;Properties must not be null&quot;);</span>
<span class="fc" id="L199">      this.properties = properties;</span>
<span class="fc" id="L200">    }</span>

    @Override
    public @Nullable String getUsername() {
<span class="fc" id="L204">      return properties.getUser();</span>
    }

    @Override
    public @Nullable String getPassword() {
<span class="fc" id="L209">      return properties.getPassword();</span>
    }

    @Override
    public @Nullable String getJdbcUrl() {
<span class="fc" id="L214">      return properties.getUrl();</span>
    }

    @Override
    public @Nullable String getDriverClassName() {
<span class="fc" id="L219">      return Optional.ofNullable(properties.getDriverClassName())</span>
<span class="fc" id="L220">          .orElseGet(LiquibaseConnectionDetails.super::getDriverClassName);</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>