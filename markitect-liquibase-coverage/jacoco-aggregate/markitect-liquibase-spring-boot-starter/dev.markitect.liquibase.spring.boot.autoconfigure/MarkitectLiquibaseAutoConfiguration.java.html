<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>MarkitectLiquibaseAutoConfiguration.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">markitect-liquibase-coverage</a> &gt; <a href="../index.html" class="el_bundle">markitect-liquibase-spring-boot-starter</a> &gt; <a href="index.source.html" class="el_package">dev.markitect.liquibase.spring.boot.autoconfigure</a> &gt; <span class="el_source">MarkitectLiquibaseAutoConfiguration.java</span></div><h1>MarkitectLiquibaseAutoConfiguration.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2023 Markitect
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package dev.markitect.liquibase.spring.boot.autoconfigure;

import static dev.markitect.liquibase.base.Preconditions.checkNotNull;
import static dev.markitect.liquibase.base.Verify.verifyNotNull;

import dev.markitect.liquibase.spring.MarkitectSpringLiquibase;
import dev.markitect.liquibase.spring.SpringLiquibaseBeanPostProcessor;
import dev.markitect.liquibase.spring.boot.autoconfigure.MarkitectLiquibaseAutoConfiguration.LiquibaseAutoConfigurationRuntimeHints;
import dev.markitect.liquibase.spring.boot.autoconfigure.MarkitectLiquibaseAutoConfiguration.LiquibaseDataSourceCondition;
import java.util.Optional;
import javax.sql.DataSource;
import liquibase.UpdateSummaryEnum;
import liquibase.UpdateSummaryOutputEnum;
import liquibase.change.DatabaseChange;
import liquibase.integration.spring.SpringLiquibase;
import liquibase.ui.UIServiceEnum;
import org.checkerframework.checker.nullness.qual.Nullable;
import org.springframework.aot.hint.RuntimeHints;
import org.springframework.aot.hint.RuntimeHintsRegistrar;
import org.springframework.beans.factory.ObjectProvider;
import org.springframework.boot.autoconfigure.AutoConfiguration;
import org.springframework.boot.autoconfigure.condition.AnyNestedCondition;
import org.springframework.boot.autoconfigure.condition.ConditionalOnBean;
import org.springframework.boot.autoconfigure.condition.ConditionalOnClass;
import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
import org.springframework.boot.autoconfigure.jdbc.JdbcConnectionDetails;
import org.springframework.boot.autoconfigure.liquibase.LiquibaseAutoConfiguration;
import org.springframework.boot.autoconfigure.liquibase.LiquibaseConnectionDetails;
import org.springframework.boot.autoconfigure.liquibase.LiquibaseDataSource;
import org.springframework.boot.autoconfigure.liquibase.LiquibaseProperties;
import org.springframework.boot.autoconfigure.orm.jpa.HibernateJpaAutoConfiguration;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.boot.jdbc.DataSourceBuilder;
import org.springframework.boot.sql.init.dependency.DatabaseInitializationDependencyConfigurer;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Conditional;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Import;
import org.springframework.context.annotation.ImportRuntimeHints;
import org.springframework.core.env.Environment;
import org.springframework.jdbc.core.ConnectionCallback;
import org.springframework.jdbc.datasource.SimpleDriverDataSource;
import org.springframework.util.Assert;
import org.springframework.util.StringUtils;

@AutoConfiguration(
    before = LiquibaseAutoConfiguration.class,
    after = {DataSourceAutoConfiguration.class, HibernateJpaAutoConfiguration.class})
@ConditionalOnClass({SpringLiquibase.class, DatabaseChange.class})
@ConditionalOnProperty(prefix = &quot;spring.liquibase&quot;, name = &quot;enabled&quot;, matchIfMissing = true)
@Conditional(LiquibaseDataSourceCondition.class)
@Import(DatabaseInitializationDependencyConfigurer.class)
@ImportRuntimeHints(LiquibaseAutoConfigurationRuntimeHints.class)
public class MarkitectLiquibaseAutoConfiguration {
  @Bean
  public static SpringLiquibaseBeanPostProcessor springLiquibaseBeanPostProcessor(
      Environment environment) {
<span class="fc" id="L76">    return new SpringLiquibaseBeanPostProcessor(environment);</span>
  }

  private MarkitectLiquibaseAutoConfiguration() {}

  @Configuration(proxyBeanMethods = false)
  @ConditionalOnClass(ConnectionCallback.class)
  @ConditionalOnMissingBean(SpringLiquibase.class)
  @EnableConfigurationProperties({LiquibaseProperties.class, MarkitectLiquibaseProperties.class})
<span class="fc" id="L85">  public static class MarkitectLiquibaseConfiguration {</span>
    @Bean
    @ConditionalOnMissingBean(LiquibaseConnectionDetails.class)
    PropertiesLiquibaseConnectionDetails liquibaseConnectionDetails(
        LiquibaseProperties properties) {
<span class="fc" id="L90">      return new PropertiesLiquibaseConnectionDetails(properties);</span>
    }

    @Bean
    SpringLiquibase liquibase(
        ObjectProvider&lt;DataSource&gt; dataSource,
        @LiquibaseDataSource @SuppressWarnings(&quot;SpringJavaInjectionPointsAutowiringInspection&quot;)
            ObjectProvider&lt;DataSource&gt; liquibaseDataSource,
        LiquibaseProperties properties,
        LiquibaseConnectionDetails connectionDetails,
        MarkitectLiquibaseProperties markitectProperties) {
<span class="fc" id="L101">      return toSpringLiquibase(</span>
<span class="fc" id="L102">          dataSource.getIfUnique(),</span>
<span class="fc" id="L103">          liquibaseDataSource.getIfAvailable(),</span>
          properties,
          connectionDetails,
          markitectProperties);
    }

    private static SpringLiquibase toSpringLiquibase(
        @Nullable DataSource dataSource,
        @Nullable DataSource liquibaseDataSource,
        LiquibaseProperties properties,
        LiquibaseConnectionDetails connectionDetails,
        MarkitectLiquibaseProperties markitectProperties) {
<span class="fc" id="L115">      var migrationDataSource =</span>
<span class="fc" id="L116">          toMigrationDataSource(liquibaseDataSource, dataSource, connectionDetails);</span>
<span class="fc" id="L117">      var liquibase = new MarkitectSpringLiquibase();</span>
<span class="fc" id="L118">      liquibase.setDropFirst(properties.isDropFirst());</span>
<span class="fc" id="L119">      liquibase.setClearCheckSums(properties.isClearChecksums());</span>
<span class="fc" id="L120">      liquibase.setShouldRun(properties.isEnabled());</span>
<span class="fc" id="L121">      liquibase.setDataSource(migrationDataSource);</span>
<span class="fc" id="L122">      liquibase.setChangeLog(properties.getChangeLog());</span>
<span class="fc" id="L123">      liquibase.setContexts(properties.getContexts());</span>
<span class="fc" id="L124">      liquibase.setLabelFilter(properties.getLabelFilter());</span>
<span class="fc" id="L125">      liquibase.setTag(properties.getTag());</span>
<span class="fc" id="L126">      liquibase.setDefaultSchema(properties.getDefaultSchema());</span>
<span class="fc" id="L127">      liquibase.setLiquibaseTablespace(properties.getLiquibaseTablespace());</span>
<span class="fc" id="L128">      liquibase.setLiquibaseSchema(properties.getLiquibaseSchema());</span>
<span class="fc" id="L129">      liquibase.setDatabaseChangeLogTable(properties.getDatabaseChangeLogTable());</span>
<span class="fc" id="L130">      liquibase.setDatabaseChangeLogLockTable(properties.getDatabaseChangeLogLockTable());</span>
<span class="fc" id="L131">      liquibase.setTestRollbackOnUpdate(properties.isTestRollbackOnUpdate());</span>
<span class="fc" id="L132">      liquibase.setChangeLogParameters(properties.getParameters());</span>
<span class="fc" id="L133">      liquibase.setRollbackFile(properties.getRollbackFile());</span>
<span class="fc" id="L134">      Optional.ofNullable(properties.getShowSummary())</span>
<span class="fc" id="L135">          .map(Enum::name)</span>
<span class="fc" id="L136">          .map(UpdateSummaryEnum::valueOf)</span>
<span class="fc" id="L137">          .ifPresent(liquibase::setShowSummary);</span>
<span class="fc" id="L138">      Optional.ofNullable(properties.getShowSummaryOutput())</span>
<span class="fc" id="L139">          .map(Enum::name)</span>
<span class="fc" id="L140">          .map(UpdateSummaryOutputEnum::valueOf)</span>
<span class="fc" id="L141">          .ifPresent(liquibase::setShowSummaryOutput);</span>
<span class="fc" id="L142">      Optional.ofNullable(properties.getUiService())</span>
<span class="fc" id="L143">          .map(Enum::name)</span>
<span class="fc" id="L144">          .map(UIServiceEnum::valueOf)</span>
<span class="fc" id="L145">          .ifPresent(liquibase::setUiService);</span>
<span class="fc" id="L146">      liquibase.setOutputDefaultCatalog(markitectProperties.isOutputDefaultCatalog());</span>
<span class="fc" id="L147">      liquibase.setOutputDefaultSchema(markitectProperties.isOutputDefaultSchema());</span>
<span class="fc" id="L148">      return liquibase;</span>
    }

    private static DataSource toMigrationDataSource(
        @Nullable DataSource liquibaseDataSource,
        @Nullable DataSource dataSource,
        LiquibaseConnectionDetails connectionDetails) {
<span class="fc bfc" id="L155" title="All 2 branches covered.">      if (liquibaseDataSource != null) {</span>
<span class="fc" id="L156">        return liquibaseDataSource;</span>
      }
<span class="fc" id="L158">      @Nullable String url = connectionDetails.getJdbcUrl();</span>
<span class="fc bfc" id="L159" title="All 2 branches covered.">      if (url != null) {</span>
<span class="fc" id="L160">        var builder = DataSourceBuilder.create();</span>
<span class="fc" id="L161">        builder.type(SimpleDriverDataSource.class);</span>
<span class="fc" id="L162">        builder.url(url);</span>
<span class="fc" id="L163">        applyCommonBuilderProperties(connectionDetails, builder);</span>
<span class="fc" id="L164">        return builder.build();</span>
      }
<span class="fc bfc" id="L166" title="All 2 branches covered.">      Assert.state(dataSource != null, &quot;Liquibase migration DataSource missing&quot;);</span>
<span class="fc bfc" id="L167" title="All 2 branches covered.">      if (connectionDetails.getUsername() != null) {</span>
<span class="fc" id="L168">        var builder = DataSourceBuilder.derivedFrom(dataSource);</span>
<span class="fc" id="L169">        builder.type(SimpleDriverDataSource.class);</span>
<span class="fc" id="L170">        applyCommonBuilderProperties(connectionDetails, builder);</span>
<span class="fc" id="L171">        return builder.build();</span>
      }
<span class="fc" id="L173">      return verifyNotNull(dataSource);</span>
    }

    private static void applyCommonBuilderProperties(
        LiquibaseConnectionDetails connectionDetails, DataSourceBuilder&lt;?&gt; builder) {
<span class="fc" id="L178">      builder.username(connectionDetails.getUsername());</span>
<span class="fc" id="L179">      builder.password(connectionDetails.getPassword());</span>
<span class="fc" id="L180">      Optional.ofNullable(connectionDetails.getDriverClassName())</span>
<span class="fc" id="L181">          .filter(StringUtils::hasText)</span>
<span class="fc" id="L182">          .ifPresent(builder::driverClassName);</span>
<span class="fc" id="L183">    }</span>
  }

  static final class LiquibaseDataSourceCondition extends AnyNestedCondition {
    LiquibaseDataSourceCondition() {
<span class="fc" id="L188">      super(ConfigurationPhase.REGISTER_BEAN);</span>
<span class="fc" id="L189">    }</span>

    @ConditionalOnBean(DataSource.class)
    @SuppressWarnings(&quot;unused&quot;)
    interface DataSourceBeanCondition {}

    @ConditionalOnBean(JdbcConnectionDetails.class)
    @SuppressWarnings(&quot;unused&quot;)
    private static final class JdbcConnectionDetailsCondition {}

    @ConditionalOnProperty(prefix = &quot;spring.liquibase&quot;, name = &quot;url&quot;)
    @SuppressWarnings(&quot;unused&quot;)
    interface LiquibaseUrlCondition {}
  }

<span class="fc" id="L204">  static class LiquibaseAutoConfigurationRuntimeHints implements RuntimeHintsRegistrar {</span>
    @Override
    public void registerHints(RuntimeHints hints, @Nullable ClassLoader classLoader) {
<span class="fc" id="L207">      hints.resources().registerPattern(&quot;db/changelog/*&quot;);</span>
<span class="fc" id="L208">    }</span>
  }

  static final class PropertiesLiquibaseConnectionDetails implements LiquibaseConnectionDetails {
    private final LiquibaseProperties properties;

<span class="fc" id="L214">    PropertiesLiquibaseConnectionDetails(LiquibaseProperties properties) {</span>
<span class="fc" id="L215">      checkNotNull(properties, &quot;Properties must not be null&quot;);</span>
<span class="fc" id="L216">      this.properties = properties;</span>
<span class="fc" id="L217">    }</span>

    @Override
    public @Nullable String getUsername() {
<span class="fc" id="L221">      return properties.getUser();</span>
    }

    @Override
    public @Nullable String getPassword() {
<span class="fc" id="L226">      return properties.getPassword();</span>
    }

    @Override
    public @Nullable String getJdbcUrl() {
<span class="fc" id="L231">      return properties.getUrl();</span>
    }

    @Override
    public @Nullable String getDriverClassName() {
<span class="fc" id="L236">      return Optional.ofNullable(properties.getDriverClassName())</span>
<span class="fc" id="L237">          .orElseGet(LiquibaseConnectionDetails.super::getDriverClassName);</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>